#!/bin/sh -e

GIT_ROOT="$(git rev-parse --show-toplevel)"
GO_ROOT="$GIT_ROOT/go"

SUMMARY_FILE="$GIT_ROOT/SUMMARY.md"

if [ -f "$SUMMARY_FILE" ]; then
  rm "$SUMMARY_FILE"
fi

echo "# Summary
" >>"$SUMMARY_FILE"

echo "## Go
" >>"$SUMMARY_FILE"

for part in $(find "$GO_ROOT/src" -mindepth 2 -maxdepth 2 -type d | tac); do
  echo "### Module $(realpath -s --relative-to "$GO_ROOT" "$part")

\`\`\`" >>"$SUMMARY_FILE"

  pushd "$part"
  timeN "$(basename $(dirname "$part"))" >>"$SUMMARY_FILE" 2>&1
  popd

  echo "\`\`\`
" >>"$SUMMARY_FILE"
done

popd

cat "$SUMMARY_FILE"
